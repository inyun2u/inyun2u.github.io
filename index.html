<!DOCTYPE html>
<html>
<head>
    <script src="jquery-2.1.1.js"></script>
    <script src="xivelyjs-1.0.4.js"></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyD5kVOArBDhdFRuKzGvCRUs70yChqrSsbs&sensor=false"></script>
    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 100% }
    </style>


</head>
<body>
<script type="text/javascript">
    function initialize() {
        var mapOptions = {
            center: new google.maps.LatLng(36.397, 127.644),
            zoom: 8
        };
        map = new google.maps.Map(document.getElementById("map-canvas"),mapOptions);
    }
    google.maps.event.addDomListener(window, 'load', initialize);
</script>

<div id="map-canvas"></div>
<script type="text/javascript">
    var devices =[
        {
            feed:"1358642428",
            key:"QuHWV9Uzh9VxpBRxMmyeK2Shf8J3v1WKDhRgjPLx48g6kEay"
        }
        ,
        {
            feed:"1340702799",
            key:"6x9rs1UD4w8DRqmaDZEagvBEnmHaegALrbR36V4ybspipOsS"
        }
    ];
    var markers=[];
    var feeds=[];
    var locations=[];
    var values =[];
    var markerIndex;
    var myLocation;
    var marker;
    var myIndex;
    var j=0;
    var obj;
    var feed;
    var key;
    function findWithAttr(array, attr, value) {
        for(var i = 0; i < array.length; i += 1) {
            if(array[i][attr] === value) {
                return i;
            }
        }
        return -1;
    }


    var setMarker = function( data ) {
        console.log("==============setmarker=================");
        console.log(data.id);
        console.log(data.datastreams[0].current_value);

        console.log("finding feed of " + data.id + " in feeds");
        myIndex=findWithAttr(feeds,"id",data.id);
        console.log("myindex is "+myIndex);
        myLocation =new google.maps.LatLng(data.location.lat,data.location.lon);
        if(myIndex==-1){
            feeds.push(data);
            console.log("none");
            marker = new google.maps.Circle({
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#FF0000',
                        fillOpacity: 0.35,
                        map:map,
                        center: myLocation,
                        title: data.datastreams[0].current_value,
                        radius: Math.sqrt(data.datastreams[0].current_value) * 500
                    }
            );
            console.log("marker made");
            markers.push(marker);
            console.log("is marker same with the one of array:");
            console.log(markers[markers.lastIndexOf(marker)]==marker);
            values.push(data.datastreams[0].current_value);

        }else{
            console.log("already has feed");

            if(feeds[myIndex].datastreams[0].current_value==data.datastreams[0].current_value) {


                console.log("no change");
               // markers[markerIndex].setMap(null);

            }else{
                console.log("feed "+ myIndex + " is changed from "+ feeds[myIndex].datastreams[0].current_value);
                console.log(" into "+data.datastreams[0].current_value);

                feeds.splice(myIndex,1);
                feeds.push(data);
                markers[myIndex].setMap(null);
                markers.splice(myIndex,1);
                console.log("removed");


                marker = new google.maps.Circle({
                            strokeColor: '#FF0000',
                            strokeOpacity: 0.8,
                            strokeWeight: 2,
                            fillColor: '#FF0000',
                            fillOpacity: 0.35,
                            map:map,
                            center: myLocation,
                            title: data.datastreams[0].current_value,
                            radius: Math.sqrt(data.datastreams[0].current_value) * 100
                        }
                );
                console.log("marker made");
                markers.push(marker);
                console.log("is marker same with the one of array:");
                console.log(markers[markers.lastIndexOf(marker)]==marker);
                values.push(data.datastreams[0].current_value);


            }

            locations.push(myLocation);
        }


    };

    setInterval(function () {

            obj = devices[j];
            key = obj.key;
            feed = obj.feed;
            xively.setKey(key);
            xively.feed.get(feed,setMarker);
            j++;
            if(j>=devices.length){
                j=0;
            }

    },3000)



</script>
</body>
</html>