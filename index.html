<!DOCTYPE html>
<html>
<head>
    <script src="jquery-2.1.1.js"></script>
    <script src="xivelyjs-1.0.4.js"></script>
    <script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?key=AIzaSyD5kVOArBDhdFRuKzGvCRUs70yChqrSsbs&sensor=false"></script>
    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0; padding: 0 }
        #map-canvas { height: 100% }
    </style>


</head>
<body>
<script type="text/javascript">
    function initialize() {
        var mapOptions = {
            center: new google.maps.LatLng(36.397, 127.644),
            zoom: 8
        };
        map = new google.maps.Map(document.getElementById("map-canvas"),mapOptions);
    }
    google.maps.event.addDomListener(window, 'load', initialize);
</script>

<div id="map-canvas"></div>
<script type="text/javascript">

    // device information
    var devices =[
        {
            feed:"1358642428",
            key:"QuHWV9Uzh9VxpBRxMmyeK2Shf8J3v1WKDhRgjPLx48g6kEay"
        }
        ,
        {
            feed:"1340702799",
            key:"6x9rs1UD4w8DRqmaDZEagvBEnmHaegALrbR36V4ybspipOsS"
        }
    ];
    var markers=[];
    var feeds=[];
    var locations=[];
    var values =[];
    var markerIndex;
    var myLocation;
    var marker;
    var myIndex;
    var j=0;
    var obj;
    var feed;
    var key;

    //finind feed of same feed id
    function findWithAttr(array, attr, value) {
        for(var i = 0; i < array.length; i += 1) {
            if(array[i][attr] === value) {
                return i;
            }
        }
        return -1;
    }


    var setMarker = function( data ) {
        //get feed from the saved with the id of data received
        myIndex=findWithAttr(feeds,"id",data.id);
        //for making marker
        myLocation =new google.maps.LatLng(data.location.lat,data.location.lon);
        //if we haven't feed of the id yet
        if(myIndex==-1){
            //save feed
            feeds.push(data);
            //make marker
            marker = new google.maps.Circle({
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#FF0000',
                        fillOpacity: 0.35,
                        map:map,
                        center: myLocation,
                        title: data.datastreams[0].current_value,
                        radius: Math.sqrt(data.datastreams[0].current_value) * 500
                    }
            );
            //save marker to separate array
            //for deleting when it is changed
            markers.push(marker);
            values.push(data.datastreams[0].current_value);
        }else{
            //if we have saved the feed before

            if(feeds[myIndex].datastreams[0].current_value==data.datastreams[0].current_value) {
                //if value is same with the value saved before
                //do nothing
            }else{
                //but if sensor value is changed
                //delete the feed from feeds array
                feeds.splice(myIndex,1);
                //push new feed
                feeds.push(data);
                //detach marker from map
                markers[myIndex].setMap(null);
                //delete marker from markers array
                markers.splice(myIndex,1);
                //make new marker
                marker = new google.maps.Circle({
                            strokeColor: '#FF0000',
                            strokeOpacity: 0.8,
                            strokeWeight: 2,
                            fillColor: '#FF0000',
                            fillOpacity: 0.35,
                            map:map,
                            center: myLocation,
                            title: data.datastreams[0].current_value,
                            radius: Math.sqrt(data.datastreams[0].current_value) * 100
                        }
                );
                //and push the new marker to merkers array
                markers.push(marker);
                values.push(data.datastreams[0].current_value);
            }
            locations.push(myLocation);
        }
    };


    //call setMarker with interval of 3secs.
    setInterval(function () {
            obj = devices[j];
            key = obj.key;
            feed = obj.feed;
            xively.setKey(key);
            xively.feed.get(feed,setMarker);
            j++;
            if(j>=devices.length){
                j=0;
            }
    },3000)
</script>
</body>
</html>